<dashboard version="1.1" theme="dark">
  <label>CCDC Network Monitor</label>
  <description>Network connections and traffic monitoring</description>

  <fieldset submitButton="false">
    <input type="time" token="time_range">
      <label>Time Range</label>
      <default>
        <earliest>-1h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="host_filter">
      <label>Host</label>
      <choice value="*">All Hosts</choice>
      <default>*</default>
      <search>
        <query>index=ccdc sourcetype=ccdc_network_monitor | stats count by host | fields host</query>
      </search>
      <fieldForLabel>host</fieldForLabel>
      <fieldForValue>host</fieldForValue>
    </input>
  </fieldset>

  <row>
    <panel>
      <title>Suspicious Connections</title>
      <single>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor ("EXTERNAL" OR "SUSPICIOUS") | stats count</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[1,5]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>New Listeners</title>
      <single>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor "NEW_LISTENER" | stats count</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[1,3]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Firewall Blocks</title>
      <single>
        <search>
          <query>index=os host=$host_filter$ (iptables OR firewalld OR ufw) (DROP OR REJECT OR BLOCK) | stats count</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Fail2ban Bans</title>
      <single>
        <search>
          <query>index=security host=$host_filter$ sourcetype=fail2ban "Ban" | stats count</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="colorMode">block</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>

  <row>
    <panel>
      <title>Network Events Timeline</title>
      <chart>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor | timechart span=5m count by host</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>Suspicious Outbound Connections</title>
      <table>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor ("EXTERNAL" OR "SUSPICIOUS") | rex field=_raw "(?&lt;local_addr&gt;[\d\.]+:\d+)\s+->\s+(?&lt;remote_addr&gt;[\d\.]+:\d+)" | table _time, host, local_addr, remote_addr, _raw | sort -_time</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
        <option name="count">20</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Connections to Suspicious Ports</title>
      <table>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor | rex field=_raw "-> [\d\.]+:(?&lt;dest_port&gt;\d+)" | where dest_port=4444 OR dest_port=5555 OR dest_port=6666 OR dest_port=1234 OR dest_port=1337 OR dest_port=31337 OR dest_port=8080 OR dest_port=9001 | table _time, host, dest_port, _raw | sort -_time</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>New Listening Services</title>
      <table>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor "NEW_LISTENER" | table _time, host, _raw | sort -_time</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Top Destination IPs</title>
      <chart>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor | rex field=_raw "-> (?&lt;dest_ip&gt;[\d\.]+):" | stats count by dest_ip | sort -count | head 10</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>60s</refresh>
        </search>
        <option name="charting.chart">bar</option>
      </chart>
    </panel>
    <panel>
      <title>Top Destination Ports</title>
      <chart>
        <search>
          <query>index=ccdc host=$host_filter$ sourcetype=ccdc_network_monitor | rex field=_raw "-> [\d\.]+:(?&lt;dest_port&gt;\d+)" | stats count by dest_port | sort -count | head 10</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>60s</refresh>
        </search>
        <option name="charting.chart">bar</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>Fail2ban Activity</title>
      <table>
        <search>
          <query>index=security host=$host_filter$ sourcetype=fail2ban | rex field=_raw "\[(?&lt;jail&gt;[^\]]+)\]\s+(?&lt;action&gt;\w+)\s+(?&lt;ip&gt;[\d\.]+)" | table _time, host, jail, action, ip | sort -_time | head 30</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Windows Firewall Events</title>
      <table>
        <search>
          <query>index=security host=$host_filter$ sourcetype="WinEventLog:Firewall" | table _time, host, src_ip, dest_ip, dest_port, action | sort -_time | head 30</query>
          <earliest>$time_range.earliest$</earliest>
          <latest>$time_range.latest$</latest>
          <refresh>60s</refresh>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
</dashboard>
