#!/bin/bash
#=============================================================================
# Remove startup_check Malware/Backdoor
#=============================================================================
# CRITICAL: Run this IMMEDIATELY on game start on ALL Linux machines
#
# This malware was discovered during early access and does the following:
# - Runs every 10 minutes via systemd
# - Spreads to other machines via SSH
# - Renames local files (/var/lib/startup.sh -> *.SAVE)
# - Logs to journal and /var/log/startup_check.log
#
# Usage:
#   sudo ./remove-startup-check-malware.sh
#   # OR via Ansible:
#   ansible linux -i inventory.ini -b -m shell -a "bash /opt/ccdc26/linux-scripts/emergency/remove-startup-check-malware.sh"
#=============================================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Must be root
if [ "$EUID" -ne 0 ]; then
   error "Must run as root"
   echo "Usage: sudo $0"
   exit 1
fi

echo ""
echo "=================================================="
echo "  REMOVING STARTUP_CHECK MALWARE"
echo "=================================================="
echo ""

# 1. Stop and disable the service
info "Stopping startup_check.service..."
if systemctl is-active --quiet startup_check.service 2>/dev/null; then
    systemctl stop startup_check.service
    echo "  ✓ Service stopped"
else
    echo "  - Service not running"
fi

if systemctl is-enabled --quiet startup_check.service 2>/dev/null; then
    systemctl disable startup_check.service
    echo "  ✓ Service disabled"
else
    echo "  - Service not enabled"
fi

# 2. Remove malware files
info "Removing malware files..."
files_removed=0

if [ -f /etc/startup_check.py ]; then
    rm -f /etc/startup_check.py
    echo "  ✓ Removed /etc/startup_check.py"
    ((files_removed++))
fi

if [ -f /etc/systemd/system/startup_check.service ]; then
    rm -f /etc/systemd/system/startup_check.service
    echo "  ✓ Removed /etc/systemd/system/startup_check.service"
    ((files_removed++))
fi

if [ -f /usr/share/startup_check-installer.sh ]; then
    rm -f /usr/share/startup_check-installer.sh
    echo "  ✓ Removed /usr/share/startup_check-installer.sh"
    ((files_removed++))
fi

if [ -f /etc/config.txt ]; then
    echo "  ! Found config file: /etc/config.txt"
    cat /etc/config.txt
    read -p "    Remove this file? (y/n): " confirm
    if [ "$confirm" = "y" ]; then
        rm -f /etc/config.txt
        echo "  ✓ Removed /etc/config.txt"
        ((files_removed++))
    fi
else
    echo "  - /etc/config.txt not found"
fi

if [ -f /var/log/startup_check.log ]; then
    rm -f /var/log/startup_check.log
    echo "  ✓ Removed /var/log/startup_check.log"
    ((files_removed++))
fi

if [ $files_removed -eq 0 ]; then
    echo "  - No malware files found"
fi

# 3. Reload systemd
info "Reloading systemd..."
systemctl daemon-reload
echo "  ✓ systemd reloaded"

# 4. Check for renamed files
info "Checking for renamed files (*.SAVE)..."
save_files=$(find /var/lib /etc /usr/share -name "*.SAVE" 2>/dev/null || true)

if [ -n "$save_files" ]; then
    warn "Found renamed files:"
    echo "$save_files" | while read -r file; do
        echo "    $file"
        original="${file%.SAVE}"
        echo "    Original: $original"
    done
    echo ""
    warn "Review these files before restoring! They may have been compromised."
    echo "    To restore: mv <file>.SAVE <file>"
else
    echo "  - No .SAVE files found"
fi

# 5. Remove SSH authorized_keys (passwordless SSH backdoor)
info "Removing SSH authorized_keys backdoors..."
keys_removed=0

for homedir in /home/* /root; do
    if [ -d "$homedir" ]; then
        auth_keys="$homedir/.ssh/authorized_keys"
        if [ -f "$auth_keys" ]; then
            echo "  ! Found authorized_keys: $auth_keys"
            cat "$auth_keys"
            read -p "    Remove this file? (y/n): " confirm
            if [ "$confirm" = "y" ]; then
                rm -f "$auth_keys"
                echo "  ✓ Removed $auth_keys"
                ((keys_removed++))
            fi
        fi
    fi
done

if [ $keys_removed -eq 0 ]; then
    echo "  - No authorized_keys files found"
fi

# 6. Check for UID 0 accounts (root equivalents)
info "Checking for UID 0 accounts..."
uid0_accounts=$(awk -F: '$3 == 0 && $1 != "root" {print $1}' /etc/passwd)

if [ -n "$uid0_accounts" ]; then
    error "FOUND UID 0 ACCOUNTS (root equivalents):"
    echo "$uid0_accounts" | while read -r user; do
        echo "    $user"
    done
    echo ""
    warn "Only 'root' should have UID 0. Investigate these accounts!"
    echo "    To remove: userdel <username>"
    echo "    To lock: usermod -L <username>"
else
    echo "  ✓ No suspicious UID 0 accounts"
fi

# 7. Verify removal
info "Verifying malware removal..."
if systemctl status startup_check.service &>/dev/null; then
    error "startup_check.service still exists!"
    systemctl status startup_check.service
else
    echo "  ✓ Service removed"
fi

if [ -f /etc/startup_check.py ] || [ -f /usr/share/startup_check-installer.sh ]; then
    error "Malware files still present!"
else
    echo "  ✓ All malware files removed"
fi

# 8. Summary
echo ""
echo "=================================================="
echo -e "${GREEN}  MALWARE REMOVAL COMPLETE${NC}"
echo "=================================================="
echo ""
echo "Actions taken:"
echo "  ✓ Stopped and disabled startup_check.service"
echo "  ✓ Removed $files_removed malware files"
echo "  ✓ Removed $keys_removed SSH authorized_keys"
echo ""

if [ -n "$save_files" ] || [ -n "$uid0_accounts" ]; then
    warn "MANUAL ACTION REQUIRED:"
    [ -n "$save_files" ] && echo "  - Review .SAVE files before restoring"
    [ -n "$uid0_accounts" ] && echo "  - Remove/lock UID 0 accounts"
fi

echo ""
info "Monitoring:"
echo "  Watch for re-creation: systemctl status startup_check.service"
echo "  Check for new files: ls -la /etc/startup_check.py /usr/share/startup_check-installer.sh"
echo "  Review logs: journalctl -u startup_check.service --no-pager | tail -20"
echo ""

info "Done! Malware removed from this machine."
echo "  Remember to run this on ALL Linux machines!"
echo ""
