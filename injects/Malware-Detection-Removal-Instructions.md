# MEMORANDUM

| | |
|---|---|
| **TO:** | System Administrators |
| **FROM:** | IT Security Team |
| **DATE:** | January 24, 2026 |
| **RE:** | Malware Detection and Removal Instructions |

---

## Executive Summary

This memo provides instructions for detecting and removing the SSH-propagating malware affecting our Linux servers. Since this is a zero-day implementation that evades traditional virus scanners, we have developed a custom detection script and comprehensive removal procedures.

**CRITICAL:** Even after removing malware from one server, nearby infected servers can re-infect it. You must clean ALL servers simultaneously and implement mitigation steps to prevent re-infection.

---

## Part 1: Malware Detection Script

### Overview

The detection script monitors for outbound SSH connections, which is the primary indicator of this malware. Normal servers should NOT be initiating outbound SSH connections unless an administrator is actively using SSH.

### Script Features

| Feature | Description |
|---------|-------------|
| Lists established TCP connections | Uses `ss -pt` to show connections with owning process |
| Flags outbound SSH | Detects connections to port 22 or SSH processes with TCP connections |
| Whitelist support | Skips known-good destinations (IPs, CIDRs, IP:port) |
| De-duplication | Writes one syslog warning per unique connection (state file) |
| Detailed logging | Timestamp, host, destination, PID, user, exe path, command line |

### Script Code

**File:** `/opt/ccdc-toolkit/linux-scripts/monitoring/detect-outbound-ssh.sh`

```bash
#!/bin/bash
#=============================================================================
# OUTBOUND SSH CONNECTION DETECTOR
#=============================================================================

set -uo pipefail

# Configuration
SSH_DEFAULT_PORTS="22"
STATE_FILE="/var/run/ssh-detector-state"
SYSLOG_FACILITY="local0"
SYSLOG_PRIORITY="warning"
SYSLOG_TAG="ssh-detector"
WHITELIST_FILE="/etc/ssh-detector-whitelist.conf"

# Built-in whitelist
BUILTIN_WHITELIST=(
    "127.0.0.1"
    "::1"
)

QUIET=false
HOSTNAME=$(hostname)

log_alert() {
    local message="$1"
    [[ "$QUIET" == "false" ]] && echo -e "\033[0;31m[ALERT]\033[0m $message"
    logger -p "${SYSLOG_FACILITY}.${SYSLOG_PRIORITY}" -t "$SYSLOG_TAG" "$message"
}

is_whitelisted() {
    local ip="$1"
    local port="${2:-}"
    
    for entry in "${BUILTIN_WHITELIST[@]}"; do
        [[ "$ip" == "$entry" ]] && return 0
        if [[ "$entry" == *"/"* ]]; then
            local prefix="${entry%/*}"
            prefix="${prefix%.*}"
            [[ "$ip" == "$prefix"* ]] && return 0
        fi
    done
    
    if [[ -f "$WHITELIST_FILE" ]]; then
        while IFS= read -r entry; do
            [[ "$entry" =~ ^# ]] && continue
            [[ -z "$entry" ]] && continue
            [[ "$ip" == "$entry" ]] && return 0
            [[ "$ip:$port" == "$entry" ]] && return 0
        done < "$WHITELIST_FILE"
    fi
    return 1
}

is_already_alerted() {
    local conn_key="$1"
    [[ -f "$STATE_FILE" ]] && grep -q "^${conn_key}$" "$STATE_FILE" 2>/dev/null
}

mark_alerted() {
    echo "$1" >> "$STATE_FILE"
}

get_process_details() {
    local pid="$1"
    local user exe cmdline
    if [[ -d "/proc/$pid" ]]; then
        user=$(stat -c '%U' "/proc/$pid" 2>/dev/null || echo "unknown")
        exe=$(readlink -f "/proc/$pid/exe" 2>/dev/null || echo "unknown")
        cmdline=$(tr '\0' ' ' < "/proc/$pid/cmdline" 2>/dev/null || echo "unknown")
        cmdline="${cmdline:0:200}"
    else
        user="unknown"; exe="unknown"; cmdline="unknown"
    fi
    echo "$user|$exe|$cmdline"
}

detect_outbound_ssh() {
    local found=0
    
    while IFS= read -r line; do
        [[ "$line" == "State"* ]] && continue
        [[ "$line" == "ESTAB"* ]] || continue
        
        local peer_addr=$(echo "$line" | awk '{print $5}')
        local process_info=$(echo "$line" | awk '{print $6}')
        
        local peer_ip="${peer_addr%:*}"
        local peer_port="${peer_addr##*:}"
        
        local pid=""
        [[ "$process_info" =~ pid=([0-9]+) ]] && pid="${BASH_REMATCH[1]}"
        
        # Check if remote port is SSH
        [[ "$peer_port" != "22" ]] && continue
        
        # Skip whitelisted
        is_whitelisted "$peer_ip" "$peer_port" && continue
        
        # Skip already alerted
        local conn_key="${peer_ip}:${peer_port}:${pid}"
        is_already_alerted "$conn_key" && continue
        
        # Get details
        local proc_details user exe cmdline
        if [[ -n "$pid" ]]; then
            IFS='|' read -r user exe cmdline <<< "$(get_process_details "$pid")"
        else
            user="unknown"; exe="unknown"; cmdline="unknown"
        fi
        
        # Alert
        log_alert "OUTBOUND SSH: host=$HOSTNAME dest=${peer_ip}:${peer_port} pid=${pid:-unknown} user=$user exe=$exe cmdline=\"$cmdline\""
        mark_alerted "$conn_key"
        ((found++))
    done < <(ss -pt state established 2>/dev/null)
    
    return $found
}

# Parse args
while [[ $# -gt 0 ]]; do
    case "$1" in
        --quiet|-q) QUIET=true; shift ;;
        *) shift ;;
    esac
done

touch "$STATE_FILE" 2>/dev/null || STATE_FILE="/tmp/ssh-detector-state"
detect_outbound_ssh
```

### Installation Instructions

```bash
# 1. Copy script to all servers
scp detect-outbound-ssh.sh root@<server>:/opt/ccdc-toolkit/linux-scripts/monitoring/

# 2. Make executable
chmod +x /opt/ccdc-toolkit/linux-scripts/monitoring/detect-outbound-ssh.sh

# 3. Create whitelist (optional - add known-good destinations)
cat > /etc/ssh-detector-whitelist.conf << 'EOF'
# Known good SSH destinations
# Add IPs, CIDRs, or IP:port entries
# 192.168.1.100
# 10.0.0.0/8
EOF

# 4. Run manually to test
/opt/ccdc-toolkit/linux-scripts/monitoring/detect-outbound-ssh.sh

# 5. Install as cron job (runs every minute)
echo '* * * * * root /opt/ccdc-toolkit/linux-scripts/monitoring/detect-outbound-ssh.sh --quiet' > /etc/cron.d/ssh-detector
```

### Sample Output

**Console:**
```
[INFO] Scanning for outbound SSH connections...
[ALERT] OUTBOUND SSH: host=webserver dest=172.20.242.102:22 pid=752 user=root exe=/usr/bin/python3 cmdline="python3 /etc/startup_check.py"
[ALERT] Found 1 suspicious outbound SSH connection(s)
```

**Syslog (`/var/log/syslog`):**
```
Jan 24 12:30:15 webserver ssh-detector[1234]: OUTBOUND SSH: host=webserver dest=172.20.242.102:22 pid=752 user=root exe=/usr/bin/python3 cmdline="python3 /etc/startup_check.py"
```

---

## Part 2: Malware Removal Instructions

### CRITICAL: Coordinate Cleanup Across ALL Servers

**WARNING:** This malware spreads via SSH. If you clean one server while others remain infected, the clean server WILL BE RE-INFECTED within 10 minutes.

**Required approach:**
1. Identify ALL infected servers first
2. Coordinate simultaneous cleanup
3. Block SSH between servers during cleanup OR clean all at once
4. Implement mitigations before restoring normal operations

### Step 1: Identify All Infected Servers

Run on EVERY Linux server:

```bash
# Check for malware process
ps aux | grep startup_check

# Check for malware files
ls -la /etc/startup_check.py /etc/config.txt /usr/share/startup_check-installer.sh 2>/dev/null

# Check for paramiko library
pip3 list 2>/dev/null | grep -i paramiko

# Check for systemd persistence
systemctl list-units --type=service | grep -i startup
ls -la /etc/systemd/system/startup*.service 2>/dev/null
```

**Document which servers are infected before proceeding.**

### Step 2: Optional - Block SSH Temporarily

To prevent re-infection during cleanup:

```bash
# Block outbound SSH (temporary)
iptables -A OUTPUT -p tcp --dport 22 -j DROP

# Or block specific infected IPs
iptables -A INPUT -s 172.20.242.30 -p tcp --dport 22 -j DROP
iptables -A OUTPUT -d 172.20.242.30 -p tcp --dport 22 -j DROP
```

### Step 3: Kill the Malware Process

```bash
# Find the PID
ps aux | grep startup_check

# Kill it
pkill -9 -f startup_check.py

# Verify it's dead
ps aux | grep startup_check
```

### Step 4: Remove Malware Files

```bash
# Remove main malware script
rm -f /etc/startup_check.py

# Remove configuration (contains credentials and targets)
rm -f /etc/config.txt

# Remove installer script
rm -f /usr/share/startup_check-installer.sh

# Remove malware log
rm -f /var/log/startup_check.log

# Remove dependency installer (check home directories)
find /home -name "install-ssh-req.sh" -delete 2>/dev/null
rm -f /root/install-ssh-req.sh
```

### Step 5: Remove Persistence Mechanism

```bash
# Stop the service
systemctl stop startup-check 2>/dev/null

# Disable it
systemctl disable startup-check 2>/dev/null

# Remove service file
rm -f /etc/systemd/system/startup-check.service
rm -f /etc/systemd/system/startup*.service

# Reload systemd
systemctl daemon-reload

# Verify removal
systemctl list-units --type=service | grep -i startup
```

### Step 6: Remove Malware Dependencies

```bash
# Uninstall paramiko
pip3 uninstall -y paramiko

# Verify removal
pip3 list | grep -i paramiko
```

### Step 7: Clean SSH Authorized Keys

The malware may have planted SSH keys for password-less access:

```bash
# Review root's authorized_keys
cat /root/.ssh/authorized_keys

# Remove any keys you don't recognize
# Edit manually or recreate with only known-good keys
nano /root/.ssh/authorized_keys

# Check all user accounts
for user in $(ls /home); do
    echo "=== $user ==="
    cat /home/$user/.ssh/authorized_keys 2>/dev/null
done
```

### Step 8: Change Passwords

```bash
# Change root password
passwd root

# Change service account passwords
passwd sysadmin
```

### Step 9: Remove Firewall Blocks (if applied)

```bash
# Remove temporary blocks
iptables -D OUTPUT -p tcp --dport 22 -j DROP
# Or flush and restore normal rules
```

### Step 10: Verify Cleanup

```bash
# No malware process
ps aux | grep startup_check

# No malware files
ls -la /etc/startup_check.py 2>&1

# No systemd service
systemctl list-units --type=service | grep -i startup

# No paramiko
pip3 list | grep -i paramiko

# Detection script shows clean
/opt/ccdc-toolkit/linux-scripts/monitoring/detect-outbound-ssh.sh
```

---

## Mitigation Steps to Prevent Re-infection

### 1. Deploy Detection Script on All Servers

```bash
# Cron job for continuous monitoring
echo '* * * * * root /opt/ccdc-toolkit/linux-scripts/monitoring/detect-outbound-ssh.sh --quiet' > /etc/cron.d/ssh-detector
```

### 2. Restrict SSH Access

```bash
# Disable root SSH login (where possible)
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
systemctl reload sshd

# Or restrict to key-only with known keys
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
```

### 3. Firewall Rules

```bash
# Restrict which servers can SSH to each other
# Only allow SSH from admin workstations
iptables -A INPUT -p tcp --dport 22 -s 172.20.240.100 -j ACCEPT  # Admin workstation
iptables -A INPUT -p tcp --dport 22 -j DROP
```

### 4. File Integrity Monitoring

Deploy the integrity monitoring scripts to detect future unauthorized changes:

```bash
./integrity-baseline.sh /etc
echo '*/5 * * * * root /opt/ccdc-toolkit/linux-scripts/monitoring/integrity-monitor.sh --all --quiet' > /etc/cron.d/integrity-monitor
```

### 5. Monitor Splunk for Alerts

```spl
index=linux-security sourcetype=syslog "ssh-detector" "OUTBOUND SSH"
| table _time, host, message
```

---

## Quick Reference: Complete Cleanup Commands

Copy and run on each infected server:

```bash
#!/bin/bash
# MALWARE CLEANUP SCRIPT - Run as root

echo "[1/8] Killing malware process..."
pkill -9 -f startup_check.py

echo "[2/8] Removing malware files..."
rm -f /etc/startup_check.py
rm -f /etc/config.txt
rm -f /usr/share/startup_check-installer.sh
rm -f /var/log/startup_check.log
find /home /root -name "install-ssh-req.sh" -delete 2>/dev/null

echo "[3/8] Removing systemd persistence..."
systemctl stop startup-check 2>/dev/null
systemctl disable startup-check 2>/dev/null
rm -f /etc/systemd/system/startup*.service
systemctl daemon-reload

echo "[4/8] Removing paramiko..."
pip3 uninstall -y paramiko 2>/dev/null

echo "[5/8] Cleaning SSH keys (REVIEW MANUALLY!)..."
echo "Current /root/.ssh/authorized_keys:"
cat /root/.ssh/authorized_keys 2>/dev/null
echo ""
echo ">>> MANUALLY REVIEW AND REMOVE UNKNOWN KEYS <<<"

echo "[6/8] Verification..."
ps aux | grep startup_check | grep -v grep && echo "WARNING: Process still running!" || echo "OK: No malware process"
ls /etc/startup_check.py 2>/dev/null && echo "WARNING: Files still exist!" || echo "OK: Files removed"
pip3 list 2>/dev/null | grep -i paramiko && echo "WARNING: Paramiko still installed!" || echo "OK: Paramiko removed"

echo "[7/8] Deploying detection script..."
# Assumes script is already in place
echo '* * * * * root /opt/ccdc-toolkit/linux-scripts/monitoring/detect-outbound-ssh.sh --quiet' > /etc/cron.d/ssh-detector

echo "[8/8] Cleanup complete!"
echo ""
echo "NEXT STEPS:"
echo "1. Change passwords: passwd root && passwd sysadmin"
echo "2. Review /root/.ssh/authorized_keys"
echo "3. Verify all servers are clean"
```

---

*Instructions prepared by IT Security Team - January 24, 2026*
