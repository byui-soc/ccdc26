# MEMORANDUM

| | |
|---|---|
| **TO:** | Management / Security Consultant |
| **FROM:** | Incident Response Team |
| **DATE:** | January 24, 2026 |
| **RE:** | SSH-Propagating Malware Analysis and Remediation |

---

## Executive Summary

**CONFIRMED: The malware infecting our organization DOES use SSH to propagate to other systems.**

Through forensic analysis, we identified a Python-based worm (`/etc/startup_check.py`) that uses the Paramiko SSH library to spread across our network. This memo details how this determination was made, the specific mechanisms used by the malware, and the remediation steps taken.

---

## Determination: SSH Propagation Confirmed

### How We Determined SSH Was Used

1. **Process Analysis**
   - Running `ps aux | grep python` revealed a suspicious process:
   ```
   root 752 0.0 0.7 ... /usr/bin/python3 /etc/startup_check.py
   ```
   - This process was running as root with no legitimate business purpose

2. **Malware Code Analysis**
   - Located malware at `/etc/startup_check.py`
   - Code review revealed explicit SSH propagation functionality:
   ```python
   import paramiko  # SSH library for Python
   
   def ssh_connect(host, user, password=None, timeout=10):
       client = paramiko.SSHClient()
       client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
       # Connects via password or SSH key authentication
       client.connect(host, username=user, password=password,
                     look_for_keys=True, allow_agent=True, timeout=timeout)
   ```

3. **Configuration File Discovery**
   - Found `/etc/config.txt` containing target hosts and credentials:
   ```
   # local target file to rename to .SAVE each cycle
   /var/lib/startup.flag
   172.20.242.102,root,
   172.20.242.254,root,
   ```
   - Empty password field indicates SSH key-based authentication

4. **Propagation Mechanism Identified**
   - Malware copies `/usr/share/startup_check-installer.sh` to remote hosts via SFTP
   - Executes the installer script remotely via SSH
   - Runs every 10 minutes (600 seconds) in a continuous loop

---

## Malware Technical Analysis

### Components Identified

| File | Purpose |
|------|---------|
| `/etc/startup_check.py` | Main malware daemon (Python) |
| `/etc/config.txt` | Target list with hosts and credentials |
| `/usr/share/startup_check-installer.sh` | Payload deployed to remote systems |
| `/var/log/startup_check.log` | Malware activity log |
| `~/install-ssh-req.sh` | Dependency installer (installs paramiko) |

### Propagation Behavior

```
Every 10 minutes:
┌─────────────────────────────────────────────────────────────┐
│ 1. Read /etc/config.txt for target hosts                    │
│ 2. For each target host:                                    │
│    a. SSH connect using stored credentials or keys          │
│    b. Check if installer script exists on remote            │
│    c. If missing: copy via SFTP and execute                 │
│ 3. Rename local target file to .SAVE                        │
│ 4. Sleep 600 seconds                                        │
│ 5. Repeat                                                   │
└─────────────────────────────────────────────────────────────┘
```

### Key Code Evidence

**SSH Connection Function:**
```python
def ssh_connect(host, user, password=None, timeout=10):
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        if password:
            client.connect(host, username=user, password=password,
                          look_for_keys=False, allow_agent=False, timeout=timeout)
        else:
            # Try key-based authentication
            client.connect(host, username=user, password=None,
                          look_for_keys=True, allow_agent=True, timeout=timeout)
        return client
    except Exception as e:
        raise ConnectionError(f"SSH connection failed to {host}: {e}")
```

**Remote Execution Function:**
```python
def copy_script_if_missing(remote):
    # ... SSH connect ...
    sftp = ssh.open_sftp()
    sftp.put(LOCAL_SCRIPT_PATH, REMOTE_SCRIPT_PATH)
    sftp.chmod(REMOTE_SCRIPT_PATH, 0o755)
    sftp.close()
    
    # Execute the script using SSH
    stdin, stdout, stderr = ssh.exec_command(f"bash {REMOTE_SCRIPT_PATH}")
```

---

## Targeted Systems

Based on `/etc/config.txt`, the following systems were targeted:

| IP Address | Username | Auth Method | Identified System | Status |
|------------|----------|-------------|-------------------|--------|
| 172.20.242.102 | root | SSH Key | Unknown (possible typo for 172.20.240.102 AD/DNS) | Checked - Clean |
| 172.20.242.254 | root | SSH Key | **Palo Alto Firewall (inside interface)** | Checked - Clean (built-in accounts only) |

**CRITICAL FINDING:** The malware was targeting the Palo Alto firewall's management interface. This indicates the attacker's intent to compromise network security controls.

**Note:** Empty password fields indicate the attacker planted SSH keys for authentication.

### Affected System Context (from network topology)

| System | IP | Role |
|--------|-----|------|
| Ubuntu Ecom (infected) | 172.20.242.30 | E-commerce server - MALWARE SOURCE |
| Palo Alto Firewall | 172.20.242.254 (inside) | Network perimeter security |
| Fedora Webmail | 172.20.242.40 | Mail server |
| Splunk | 172.20.242.20 | Logging server |

---

## Steps Taken to Thwart Further Spread

### Immediate Containment

1. **Killed Malware Process**
   ```bash
   sudo kill -9 752
   ```

2. **Removed Malware Components**
   ```bash
   sudo rm -f /etc/startup_check.py
   sudo rm -f /etc/config.txt
   sudo rm -f /usr/share/startup_check-installer.sh
   sudo rm -f /var/log/startup_check.log
   sudo rm -f ~/install-ssh-req.sh
   ```

3. **Disabled Persistence Mechanism**
   ```bash
   sudo systemctl disable startup-check
   sudo rm -f /etc/systemd/system/startup*.service
   sudo systemctl daemon-reload
   ```

4. **Removed Paramiko Dependency**
   ```bash
   sudo pip3 uninstall -y paramiko
   ```

### Network-Wide Remediation

5. **Checked All Linux Systems**
   - Searched for malware presence on all Linux hosts
   - Commands run on each system:
   ```bash
   ps aux | grep startup_check
   ls -la /etc/startup_check.py
   ls -la /etc/config.txt
   ls -la /usr/share/startup_check-installer.sh
   ```

6. **SSH Key Audit**
   - Reviewed `/root/.ssh/authorized_keys` on all systems
   - Removed unrecognized SSH keys planted by attacker
   ```bash
   cat /root/.ssh/authorized_keys
   # Removed any keys not belonging to legitimate administrators
   ```

7. **Password Rotation**
   - Changed root passwords on all affected systems
   - Changed sysadmin passwords across the network

---

## How to Find and Remove This Malware

### Detection Commands

```bash
# Check for running malware process
ps aux | grep -E "startup_check|paramiko"

# Check for malware files
ls -la /etc/startup_check.py
ls -la /etc/config.txt
ls -la /usr/share/startup_check-installer.sh
ls -la /var/log/startup_check.log

# Check for paramiko library
pip3 list | grep -i paramiko

# Check for suspicious systemd services
systemctl list-units --type=service | grep -i startup
ls -la /etc/systemd/system/ | grep -i startup

# Check for planted SSH keys
cat /root/.ssh/authorized_keys
for user in $(ls /home); do cat /home/$user/.ssh/authorized_keys 2>/dev/null; done
```

### Removal Commands

```bash
# 1. Kill the process
pkill -9 -f startup_check.py

# 2. Remove all malware files
sudo rm -f /etc/startup_check.py
sudo rm -f /etc/config.txt
sudo rm -f /usr/share/startup_check-installer.sh
sudo rm -f /var/log/startup_check.log
sudo rm -f /var/lib/startup.flag
sudo rm -f /var/lib/startup.flag.SAVE

# 3. Remove persistence
sudo systemctl stop startup-check 2>/dev/null
sudo systemctl disable startup-check 2>/dev/null
sudo rm -f /etc/systemd/system/startup*.service
sudo systemctl daemon-reload

# 4. Remove SSH dependencies
sudo pip3 uninstall -y paramiko

# 5. Clean SSH authorized_keys (REVIEW BEFORE RUNNING)
# Manually review and remove unknown keys from:
#   /root/.ssh/authorized_keys
#   /home/*/.ssh/authorized_keys

# 6. Verify removal
ps aux | grep startup_check
ls -la /etc/startup_check.py 2>&1
```

---

## Indicators of Compromise (IOCs)

### File-Based IOCs

| Path | SHA256 (if available) |
|------|----------------------|
| `/etc/startup_check.py` | <!-- Calculate with sha256sum --> |
| `/etc/config.txt` | <!-- Calculate with sha256sum --> |
| `/usr/share/startup_check-installer.sh` | <!-- Calculate with sha256sum --> |
| `~/install-ssh-req.sh` | <!-- Calculate with sha256sum --> |

### Process-Based IOCs

- Process name containing `startup_check`
- Python process running from `/etc/`
- Root process using paramiko library

### Network-Based IOCs

- SSH connections from unexpected hosts
- SSH connections to internal hosts on port 22 from compromised systems
- Outbound SSH from servers that shouldn't initiate SSH

---

## Recommendations

1. **Implement SSH Key Management** - Maintain inventory of all authorized SSH keys
2. **Deploy File Integrity Monitoring** - Alert on new files in /etc/ and /usr/share/
3. **Restrict Root SSH** - Disable root SSH login where possible (`PermitRootLogin no`)
4. **Network Segmentation** - Limit SSH access between systems
5. **Monitor for Paramiko** - Alert if paramiko is installed on systems

---

## Remediation Status

| System | Status | Actions Taken |
|--------|--------|---------------|
| Ubuntu Ecom (172.20.242.30) | **CLEANED** | Killed process, removed all malware files, removed paramiko |
| Fedora Webmail (172.20.242.40) | **CLEANED** | Checked and cleaned |
| Splunk (172.20.242.20) | **CLEANED** | Checked and cleaned |
| Palo Alto Firewall | **VERIFIED CLEAN** | Checked admin accounts - only built-in accounts present |
| All Linux Systems | **CLEANED** | SSH authorized_keys audited, malware removed |

---

## Conclusion

The malware infection has been **confirmed to use SSH** (via Python's Paramiko library) for propagation. The worm was designed to spread automatically to other systems using stolen credentials and planted SSH keys. 

**All identified malware components have been successfully removed:**
- Malware daemon (`/etc/startup_check.py`) - REMOVED
- Configuration file (`/etc/config.txt`) - REMOVED  
- Installer script (`/usr/share/startup_check-installer.sh`) - REMOVED
- Dependency installer (`install-ssh-req.sh`) - REMOVED
- Paramiko library - UNINSTALLED
- Persistence mechanisms - DISABLED

The Palo Alto firewall was verified clean - only built-in system accounts (admin, panorama, cliuser) were present, and no unauthorized SSH keys or configurations were found.

Network-wide scans have been completed and all affected systems have been remediated.

---

*Report prepared by Incident Response Team - January 24, 2026*
