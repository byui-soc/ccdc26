---
# CCDC26 - Deploy Wazuh Agent Playbook
#
# Deploys Wazuh agent to all hosts and configures log forwarding
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_wazuh.yml -e "wazuh_manager=10.0.0.100"
#
# Optional variables:
#   -e "wazuh_registration_password=MySecretPassword"
#   -e "wazuh_agent_group=linux"
#

- name: Deploy Wazuh agent to Linux hosts
  hosts: linux
  become: yes
  gather_facts: yes

  vars:
    manager_ip: "{{ wazuh_manager | default('CHANGE_ME') }}"
    reg_password: "{{ wazuh_registration_password | default('') }}"
    agent_group: "{{ wazuh_agent_group | default('linux') }}"
    wazuh_version: "4.7.2"
    toolkit_dest: "/opt/ccdc26"

  tasks:
    - name: Fail if wazuh_manager not configured
      fail:
        msg: "wazuh_manager must be set! Use -e 'wazuh_manager=IP'"
      when: manager_ip == 'CHANGE_ME'

    - name: Detect OS distribution and family
      set_fact:
        os_distribution: "{{ ansible_distribution | lower | default('unknown') }}"
        os_family: "{{ ansible_os_family | lower | default('unknown') }}"
        python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"
      changed_when: false

    - name: Handle Oracle Linux as RHEL family
      set_fact:
        os_family: "redhat"
      when: 
        - os_distribution == 'oracle linux' or os_distribution == 'ol'
        - os_family != 'redhat'

    - name: Verify Python interpreter exists
      stat:
        path: "{{ python_interpreter }}"
      register: python_check
      changed_when: false

    - name: Find alternative Python interpreter
      shell: |
        for py in python3 python /usr/bin/python3 /usr/bin/python /usr/libexec/platform-python; do
          if command -v $py >/dev/null 2>&1; then
            echo $py
            exit 0
          fi
        done
        echo "python3"
      register: python_fallback
      changed_when: false
      when: not python_check.stat.exists
      ignore_errors: yes

    - name: Set Python interpreter from fallback
      set_fact:
        python_interpreter: "{{ python_fallback.stdout | default('/usr/bin/python3') }}"
      when: not python_check.stat.exists

    - name: Display detected OS information
      debug:
        msg: |
          OS Distribution: {{ os_distribution }}
          OS Family: {{ os_family }}
          Python Interpreter: {{ python_interpreter }}
      changed_when: false

    # Debian/Ubuntu Installation
    - name: Add Wazuh GPG key (Debian/Ubuntu)
      when: 
        - os_family == 'debian' or os_distribution in ['ubuntu', 'debian']
      block:
        - name: Install prerequisites
          apt:
            name:
              - curl
              - apt-transport-https
              - gnupg2
            state: present
            update_cache: yes

        - name: Add Wazuh GPG key
          shell: |
            curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | gpg --dearmor -o /usr/share/keyrings/wazuh.gpg
          args:
            creates: /usr/share/keyrings/wazuh.gpg

        - name: Add Wazuh repository
          copy:
            dest: /etc/apt/sources.list.d/wazuh.list
            content: "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main"
            mode: '0644'

        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install Wazuh agent
          apt:
            name: wazuh-agent
            state: present
          environment:
            WAZUH_MANAGER: "{{ manager_ip }}"

    # RHEL/CentOS/Oracle Linux Installation
    - name: Add Wazuh repository (RHEL/CentOS/Oracle Linux)
      when: 
        - os_family == 'redhat' or os_distribution in ['centos', 'rhel', 'red hat', 'oracle linux', 'ol', 'rocky', 'almalinux', 'fedora']
      block:
        - name: Import Wazuh GPG key
          rpm_key:
            key: https://packages.wazuh.com/key/GPG-KEY-WAZUH
            state: present

        - name: Add Wazuh repository
          copy:
            dest: /etc/yum.repos.d/wazuh.repo
            content: |
              [wazuh]
              name=Wazuh repository
              baseurl=https://packages.wazuh.com/4.x/yum/
              gpgcheck=1
              gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH
              enabled=1
              protect=1
            mode: '0644'

        - name: Install Wazuh agent (RHEL/CentOS/Oracle)
          yum:
            name: wazuh-agent
            state: present
          environment:
            WAZUH_MANAGER: "{{ manager_ip }}"
          vars:
            ansible_python_interpreter: "{{ python_interpreter }}"
          when: os_distribution not in ['fedora']

        - name: Install Wazuh agent (Fedora)
          dnf:
            name: wazuh-agent
            state: present
          environment:
            WAZUH_MANAGER: "{{ manager_ip }}"
          vars:
            ansible_python_interpreter: "{{ python_interpreter }}"
          when: os_distribution == 'fedora'

    # Configuration (all Linux)
    - name: Configure Wazuh agent
      copy:
        dest: /var/ossec/etc/ossec.conf
        owner: root
        group: wazuh
        mode: '0640'
        backup: yes
        content: |
          <!--
            Wazuh Agent Configuration
            Managed by Ansible - CCDC26
          -->
          <ossec_config>
            <client>
              <server>
                <address>{{ manager_ip }}</address>
                <port>1514</port>
                <protocol>tcp</protocol>
              </server>
              <config-profile>{{ ansible_distribution | lower | default('linux') }}</config-profile>
              <notify_time>10</notify_time>
              <time-reconnect>60</time-reconnect>
              <auto_restart>yes</auto_restart>
            </client>

            <client_buffer>
              <disabled>no</disabled>
              <queue_size>5000</queue_size>
              <events_per_second>500</events_per_second>
            </client_buffer>

            <!-- Log Collection -->
            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/auth.log</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/secure</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/syslog</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/messages</location>
            </localfile>

            <localfile>
              <log_format>audit</log_format>
              <location>/var/log/audit/audit.log</location>
            </localfile>

            <!-- Web Server Logs -->
            <localfile>
              <log_format>apache</log_format>
              <location>/var/log/apache2/*.log</location>
            </localfile>

            <localfile>
              <log_format>apache</log_format>
              <location>/var/log/httpd/*_log</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/nginx/*.log</location>
            </localfile>

            <!-- Database Logs -->
            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/mysql/*.log</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/postgresql/*.log</location>
            </localfile>

            <!-- File Integrity Monitoring -->
            <syscheck>
              <disabled>no</disabled>
              <frequency>300</frequency>
              <scan_on_start>yes</scan_on_start>
              <alert_new_files>yes</alert_new_files>

              <directories check_all="yes" realtime="yes">/etc</directories>
              <directories check_all="yes" realtime="yes">/usr/bin</directories>
              <directories check_all="yes" realtime="yes">/usr/sbin</directories>
              <directories check_all="yes" realtime="yes">/bin</directories>
              <directories check_all="yes" realtime="yes">/sbin</directories>
              <directories check_all="yes" realtime="yes">/var/www</directories>

              <ignore>/etc/mtab</ignore>
              <ignore>/etc/resolv.conf</ignore>
              <ignore type="sregex">.log$|.swp$</ignore>
            </syscheck>

            <!-- Rootcheck -->
            <rootcheck>
              <disabled>no</disabled>
              <check_files>yes</check_files>
              <check_trojans>yes</check_trojans>
              <check_dev>yes</check_dev>
              <check_sys>yes</check_sys>
              <check_pids>yes</check_pids>
              <check_ports>yes</check_ports>
              <check_if>yes</check_if>
              <frequency>43200</frequency>
            </rootcheck>

            <!-- System Inventory -->
            <wodle name="syscollector">
              <disabled>no</disabled>
              <interval>1h</interval>
              <scan_on_start>yes</scan_on_start>
              <packages>yes</packages>
              <os>yes</os>
              <ports all="no">yes</ports>
              <processes>yes</processes>
            </wodle>

            <!-- Active Response -->
            <active-response>
              <disabled>no</disabled>
            </active-response>

            <logging>
              <log_format>json</log_format>
            </logging>
          </ossec_config>
      when: 
        - os_family in ['debian', 'redhat'] or os_distribution in ['ubuntu', 'debian', 'centos', 'rhel', 'red hat', 'oracle linux', 'ol', 'rocky', 'almalinux', 'fedora']
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ python_interpreter }}"

    # Registration
    - name: Check if agent is registered
      stat:
        path: /var/ossec/etc/client.keys
      register: client_keys

    - name: Test connectivity to Wazuh manager
      shell: |
        timeout 5 bash -c "echo > /dev/tcp/{{ manager_ip }}/1514" 2>/dev/null || nc -zv {{ manager_ip }} 1514 2>&1 | head -1
      register: connectivity_test
      changed_when: false
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ python_interpreter }}"

    - name: Warn if manager connectivity fails
      debug:
        msg: "WARNING: Cannot reach Wazuh manager at {{ manager_ip }}:1514. Check firewall rules and network connectivity."
      when: connectivity_test.rc != 0
      vars:
        ansible_python_interpreter: "{{ python_interpreter }}"

    - name: Register agent with manager
      shell: |
        /var/ossec/bin/agent-auth -m {{ manager_ip }} -A {{ ansible_hostname }} {% if reg_password %}-P {{ reg_password }}{% endif %} {% if agent_group != 'default' %}-G {{ agent_group }}{% endif %}
      when: 
        - not client_keys.stat.exists or client_keys.stat.size == 0
        - connectivity_test.rc == 0
      register: agent_auth
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ python_interpreter }}"

    - name: Display registration result
      debug:
        msg: "Agent registration: {{ 'successful' if (agent_auth.rc | default(1)) == 0 else 'skipped or requires manual registration' }}"
      when: agent_auth is defined and agent_auth.rc is defined

    # Service management
    - name: Disable Wazuh repo updates (lock version - Debian/Ubuntu)
      shell: echo "wazuh-agent hold" | dpkg --set-selections
      when: os_family == 'debian' or os_distribution in ['ubuntu', 'debian']
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ python_interpreter }}"

    - name: Disable Wazuh repo updates (lock version - RHEL/CentOS/Oracle)
      shell: |
        if [ -f /etc/yum.repos.d/wazuh.repo ]; then
          sed -i 's/^enabled=1/enabled=0/' /etc/yum.repos.d/wazuh.repo
        fi
      when: os_family == 'redhat' or os_distribution in ['centos', 'rhel', 'red hat', 'oracle linux', 'ol', 'rocky', 'almalinux']
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ python_interpreter }}"

    - name: Enable and start Wazuh agent service
      systemd:
        name: wazuh-agent
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Verify Wazuh agent is running
      shell: systemctl is-active wazuh-agent
      register: wazuh_status
      changed_when: false
      ignore_errors: yes

    - name: Display Wazuh agent status
      debug:
        msg: |
          Wazuh Agent Status: {{ wazuh_status.stdout }}
          Manager: {{ manager_ip }}


- name: Deploy Wazuh agent to Windows hosts
  hosts: windows
  gather_facts: yes

  vars:
    manager_ip: "{{ wazuh_manager | default('CHANGE_ME') }}"
    reg_password: "{{ wazuh_registration_password | default('') }}"
    agent_group: "{{ wazuh_agent_group | default('windows') }}"
    wazuh_version: "4.7.2"
    toolkit_dest: "C:\\CCDC-Toolkit"

  tasks:
    - name: Fail if wazuh_manager not configured
      fail:
        msg: "wazuh_manager must be set! Use -e 'wazuh_manager=IP'"
      when: manager_ip == 'CHANGE_ME'

    - name: Test connectivity to Wazuh manager (Windows)
      win_shell: |
        $tcpClient = New-Object System.Net.Sockets.TcpClient
        try {
          $tcpClient.Connect("{{ manager_ip }}", 1514)
          $tcpClient.Close()
          Write-Output "SUCCESS"
        } catch {
          Write-Output "FAILED: $_"
          exit 1
        }
      register: win_connectivity_test
      changed_when: false
      ignore_errors: yes

    - name: Warn if manager connectivity fails (Windows)
      debug:
        msg: "WARNING: Cannot reach Wazuh manager at {{ manager_ip }}:1514. Check firewall rules and network connectivity. Ensure Cisco FTD allows traffic from Windows subnet to Linux subnet."
      when: win_connectivity_test.rc != 0

    - name: Check if Wazuh agent is already installed
      win_stat:
        path: "C:\\Program Files (x86)\\ossec-agent\\wazuh-agent.exe"
      register: wazuh_installed

    - name: Download Wazuh agent MSI
      win_get_url:
        url: "https://packages.wazuh.com/4.x/windows/wazuh-agent-{{ wazuh_version }}-1.msi"
        dest: "{{ ansible_env.TEMP }}\\wazuh-agent.msi"
      when: not wazuh_installed.stat.exists

    - name: Install Wazuh agent
      win_package:
        path: "{{ ansible_env.TEMP }}\\wazuh-agent.msi"
        arguments: >-
          WAZUH_MANAGER={{ manager_ip }}
          WAZUH_AGENT_GROUP={{ agent_group }}
          {% if reg_password %}WAZUH_REGISTRATION_PASSWORD={{ reg_password }}{% endif %}
        state: present
      when: 
        - not wazuh_installed.stat.exists
        - win_connectivity_test.rc == 0
      register: wazuh_install
      ignore_errors: yes

    - name: Display installation result
      debug:
        msg: "Wazuh agent installation: {{ 'successful' if (wazuh_install.rc | default(1)) == 0 else 'failed - check logs' }}"
      when: wazuh_install is defined

    - name: Remove installer
      win_file:
        path: "{{ ansible_env.TEMP }}\\wazuh-agent.msi"
        state: absent

    - name: Enable PowerShell Script Block Logging
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
        name: EnableScriptBlockLogging
        data: 1
        type: dword

    - name: Enable PowerShell Module Logging
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging
        name: EnableModuleLogging
        data: 1
        type: dword

    - name: Enable command line auditing
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit
        name: ProcessCreationIncludeCmdLine_Enabled
        data: 1
        type: dword

    - name: Enable Process Creation auditing
      win_shell: |
        auditpol /set /subcategory:"Process Creation" /success:enable /failure:enable
      ignore_errors: yes

    - name: Ensure Wazuh agent service is running
      win_service:
        name: WazuhSvc
        start_mode: auto
        state: started
      ignore_errors: yes
      when: wazuh_installed.stat.exists or (wazuh_install is defined and wazuh_install.rc == 0)

    - name: Get Wazuh service status
      win_shell: |
        $svc = Get-Service -Name WazuhSvc -ErrorAction SilentlyContinue
        if ($svc) { 
          Write-Output "Status: $($svc.Status)"
          Write-Output "StartType: $($svc.StartType)"
        } else { 
          Write-Output "Not installed" 
        }
      register: wazuh_service
      changed_when: false
      ignore_errors: yes

    - name: Check agent connection to manager
      win_shell: |
        if (Test-Path "C:\Program Files (x86)\ossec-agent\ossec.log") {
          $lastLines = Get-Content "C:\Program Files (x86)\ossec-agent\ossec.log" -Tail 10
          $connected = $lastLines | Select-String -Pattern "Connected|Successfully"
          if ($connected) {
            Write-Output "Agent appears to be connected to manager"
          } else {
            Write-Output "Agent may not be connected - check logs"
          }
        } else {
          Write-Output "Log file not found"
        }
      register: agent_connection_check
      changed_when: false
      ignore_errors: yes

    - name: Display Wazuh agent status
      debug:
        msg: |
          Wazuh Agent Service: {{ wazuh_service.stdout | trim }}
          Manager: {{ manager_ip }}
          Connectivity Test: {{ 'PASSED' if win_connectivity_test.rc == 0 else 'FAILED' }}
          Connection Status: {{ agent_connection_check.stdout | default('Unknown') }}
