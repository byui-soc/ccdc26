---
# CCDC26 - Deploy Wazuh Agent Playbook
#
# Deploys Wazuh agent to all hosts and configures log forwarding
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_wazuh.yml -e "wazuh_manager=10.0.0.100"
#
# Optional variables:
#   -e "wazuh_registration_password=MySecretPassword"
#   -e "wazuh_agent_group=linux"
#

- name: Deploy Wazuh agent to Linux hosts
  hosts: linux
  become: yes
  gather_facts: yes

  vars:
    manager_ip: "{{ wazuh_manager | default('CHANGE_ME') }}"
    reg_password: "{{ wazuh_registration_password | default('') }}"
    agent_group: "{{ wazuh_agent_group | default('linux') }}"
    wazuh_version: "4.7.2"
    toolkit_dest: "/opt/ccdc26"

  tasks:
    - name: Fail if wazuh_manager not configured
      fail:
        msg: "wazuh_manager must be set! Use -e 'wazuh_manager=IP'"
      when: manager_ip == 'CHANGE_ME'

    - name: Detect OS family
      set_fact:
        os_family: "{{ ansible_os_family | lower }}"

    # Debian/Ubuntu Installation
    - name: Add Wazuh GPG key (Debian/Ubuntu)
      when: os_family == 'debian'
      block:
        - name: Install prerequisites
          apt:
            name:
              - curl
              - apt-transport-https
              - gnupg2
            state: present
            update_cache: yes

        - name: Add Wazuh GPG key
          shell: |
            curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | gpg --dearmor -o /usr/share/keyrings/wazuh.gpg
          args:
            creates: /usr/share/keyrings/wazuh.gpg

        - name: Add Wazuh repository
          copy:
            dest: /etc/apt/sources.list.d/wazuh.list
            content: "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main"
            mode: '0644'

        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install Wazuh agent
          apt:
            name: wazuh-agent
            state: present
          environment:
            WAZUH_MANAGER: "{{ manager_ip }}"

    # RHEL/CentOS Installation
    - name: Add Wazuh repository (RHEL/CentOS)
      when: os_family == 'redhat'
      block:
        - name: Import Wazuh GPG key
          rpm_key:
            key: https://packages.wazuh.com/key/GPG-KEY-WAZUH
            state: present

        - name: Add Wazuh repository
          copy:
            dest: /etc/yum.repos.d/wazuh.repo
            content: |
              [wazuh]
              name=Wazuh repository
              baseurl=https://packages.wazuh.com/4.x/yum/
              gpgcheck=1
              gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH
              enabled=1
              protect=1
            mode: '0644'

        - name: Install Wazuh agent
          yum:
            name: wazuh-agent
            state: present
          environment:
            WAZUH_MANAGER: "{{ manager_ip }}"

    # Configuration (all Linux)
    - name: Configure Wazuh agent
      copy:
        dest: /var/ossec/etc/ossec.conf
        owner: root
        group: wazuh
        mode: '0640'
        backup: yes
        content: |
          <!--
            Wazuh Agent Configuration
            Managed by Ansible - CCDC26
          -->
          <ossec_config>
            <client>
              <server>
                <address>{{ manager_ip }}</address>
                <port>1514</port>
                <protocol>tcp</protocol>
              </server>
              <config-profile>{{ ansible_distribution | lower | default('linux') }}</config-profile>
              <notify_time>10</notify_time>
              <time-reconnect>60</time-reconnect>
              <auto_restart>yes</auto_restart>
            </client>

            <client_buffer>
              <disabled>no</disabled>
              <queue_size>5000</queue_size>
              <events_per_second>500</events_per_second>
            </client_buffer>

            <!-- Log Collection -->
            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/auth.log</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/secure</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/syslog</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/messages</location>
            </localfile>

            <localfile>
              <log_format>audit</log_format>
              <location>/var/log/audit/audit.log</location>
            </localfile>

            <!-- Web Server Logs -->
            <localfile>
              <log_format>apache</log_format>
              <location>/var/log/apache2/*.log</location>
            </localfile>

            <localfile>
              <log_format>apache</log_format>
              <location>/var/log/httpd/*_log</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/nginx/*.log</location>
            </localfile>

            <!-- Database Logs -->
            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/mysql/*.log</location>
            </localfile>

            <localfile>
              <log_format>syslog</log_format>
              <location>/var/log/postgresql/*.log</location>
            </localfile>

            <!-- File Integrity Monitoring -->
            <syscheck>
              <disabled>no</disabled>
              <frequency>300</frequency>
              <scan_on_start>yes</scan_on_start>
              <alert_new_files>yes</alert_new_files>

              <directories check_all="yes" realtime="yes">/etc</directories>
              <directories check_all="yes" realtime="yes">/usr/bin</directories>
              <directories check_all="yes" realtime="yes">/usr/sbin</directories>
              <directories check_all="yes" realtime="yes">/bin</directories>
              <directories check_all="yes" realtime="yes">/sbin</directories>
              <directories check_all="yes" realtime="yes">/var/www</directories>

              <ignore>/etc/mtab</ignore>
              <ignore>/etc/resolv.conf</ignore>
              <ignore type="sregex">.log$|.swp$</ignore>
            </syscheck>

            <!-- Rootcheck -->
            <rootcheck>
              <disabled>no</disabled>
              <check_files>yes</check_files>
              <check_trojans>yes</check_trojans>
              <check_dev>yes</check_dev>
              <check_sys>yes</check_sys>
              <check_pids>yes</check_pids>
              <check_ports>yes</check_ports>
              <check_if>yes</check_if>
              <frequency>43200</frequency>
            </rootcheck>

            <!-- System Inventory -->
            <wodle name="syscollector">
              <disabled>no</disabled>
              <interval>1h</interval>
              <scan_on_start>yes</scan_on_start>
              <packages>yes</packages>
              <os>yes</os>
              <ports all="no">yes</ports>
              <processes>yes</processes>
            </wodle>

            <!-- Active Response -->
            <active-response>
              <disabled>no</disabled>
            </active-response>

            <logging>
              <log_format>json</log_format>
            </logging>
          </ossec_config>
      when: ansible_os_family in ['Debian', 'RedHat']
      ignore_errors: yes

    # Registration
    - name: Check if agent is registered
      stat:
        path: /var/ossec/etc/client.keys
      register: client_keys

    - name: Register agent with manager
      shell: |
        /var/ossec/bin/agent-auth -m {{ manager_ip }} -A {{ ansible_hostname }} {% if reg_password %}-P {{ reg_password }}{% endif %} {% if agent_group != 'default' %}-G {{ agent_group }}{% endif %}
      when: not client_keys.stat.exists or client_keys.stat.size == 0
      register: agent_auth
      ignore_errors: yes

    - name: Display registration result
      debug:
        msg: "Agent registration: {{ 'successful' if (agent_auth.rc | default(1)) == 0 else 'skipped or requires manual registration' }}"
      when: agent_auth is defined and agent_auth.rc is defined

    # Service management
    - name: Disable Wazuh repo updates (lock version)
      shell: echo "wazuh-agent hold" | dpkg --set-selections
      when: os_family == 'debian'
      ignore_errors: yes

    - name: Enable and start Wazuh agent service
      systemd:
        name: wazuh-agent
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Verify Wazuh agent is running
      shell: systemctl is-active wazuh-agent
      register: wazuh_status
      changed_when: false
      ignore_errors: yes

    - name: Display Wazuh agent status
      debug:
        msg: |
          Wazuh Agent Status: {{ wazuh_status.stdout }}
          Manager: {{ manager_ip }}


- name: Deploy Wazuh agent to Windows hosts
  hosts: windows
  gather_facts: yes

  vars:
    manager_ip: "{{ wazuh_manager | default('CHANGE_ME') }}"
    reg_password: "{{ wazuh_registration_password | default('') }}"
    agent_group: "{{ wazuh_agent_group | default('windows') }}"
    wazuh_version: "4.7.2"
    toolkit_dest: "C:\\CCDC-Toolkit"

  tasks:
    - name: Fail if wazuh_manager not configured
      fail:
        msg: "wazuh_manager must be set! Use -e 'wazuh_manager=IP'"
      when: manager_ip == 'CHANGE_ME'

    - name: Check if Wazuh agent is already installed
      win_stat:
        path: "C:\\Program Files (x86)\\ossec-agent\\wazuh-agent.exe"
      register: wazuh_installed

    - name: Download Wazuh agent MSI
      win_get_url:
        url: "https://packages.wazuh.com/4.x/windows/wazuh-agent-{{ wazuh_version }}-1.msi"
        dest: "{{ ansible_env.TEMP }}\\wazuh-agent.msi"
      when: not wazuh_installed.stat.exists

    - name: Install Wazuh agent
      win_package:
        path: "{{ ansible_env.TEMP }}\\wazuh-agent.msi"
        arguments: >-
          WAZUH_MANAGER={{ manager_ip }}
          WAZUH_AGENT_GROUP={{ agent_group }}
          {% if reg_password %}WAZUH_REGISTRATION_PASSWORD={{ reg_password }}{% endif %}
        state: present
      when: not wazuh_installed.stat.exists
      register: wazuh_install

    - name: Remove installer
      win_file:
        path: "{{ ansible_env.TEMP }}\\wazuh-agent.msi"
        state: absent

    - name: Enable PowerShell Script Block Logging
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
        name: EnableScriptBlockLogging
        data: 1
        type: dword

    - name: Enable PowerShell Module Logging
      win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ModuleLogging
        name: EnableModuleLogging
        data: 1
        type: dword

    - name: Enable command line auditing
      win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit
        name: ProcessCreationIncludeCmdLine_Enabled
        data: 1
        type: dword

    - name: Enable Process Creation auditing
      win_shell: |
        auditpol /set /subcategory:"Process Creation" /success:enable /failure:enable
      ignore_errors: yes

    - name: Ensure Wazuh agent service is running
      win_service:
        name: WazuhSvc
        start_mode: auto
        state: started

    - name: Get Wazuh service status
      win_shell: |
        $svc = Get-Service -Name WazuhSvc -ErrorAction SilentlyContinue
        if ($svc) { $svc.Status } else { "Not installed" }
      register: wazuh_service

    - name: Display Wazuh agent status
      debug:
        msg: |
          Wazuh Agent Service: {{ wazuh_service.stdout | trim }}
          Manager: {{ manager_ip }}
