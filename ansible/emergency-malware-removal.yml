---
#=============================================================================
# Emergency Malware Removal Playbook
#=============================================================================
# CRITICAL: Run this IMMEDIATELY on game start
#
# Removes the startup_check malware/backdoor discovered during early access
#
# Usage:
#   ansible-playbook -i inventory.ini emergency-malware-removal.yml --ask-become-pass
#   # OR if passwords in inventory:
#   ansible-playbook -i inventory.ini emergency-malware-removal.yml
#=============================================================================

- name: Emergency Malware Removal - startup_check Backdoor
  hosts: linux
  become: yes
  gather_facts: no
  
  tasks:
    - name: Check if malware exists
      stat:
        path: /etc/startup_check.py
      register: malware_check
      ignore_errors: yes
    
    - name: Display malware status
      debug:
        msg: "Malware {{ 'FOUND' if malware_check.stat.exists else 'NOT FOUND' }} on {{ inventory_hostname }}"
    
    - name: Stop startup_check service
      systemd:
        name: startup_check.service
        state: stopped
      ignore_errors: yes
      when: malware_check.stat.exists
    
    - name: Disable startup_check service
      systemd:
        name: startup_check.service
        enabled: no
      ignore_errors: yes
      when: malware_check.stat.exists
    
    - name: Remove malware files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/startup_check.py
        - /etc/systemd/system/startup_check.service
        - /usr/share/startup_check-installer.sh
        - /etc/config.txt
        - /var/log/startup_check.log
      when: malware_check.stat.exists
    
    - name: Reload systemd
      systemd:
        daemon_reload: yes
      when: malware_check.stat.exists
    
    - name: Find SSH authorized_keys files
      find:
        paths:
          - /home
          - /root
        patterns: "authorized_keys"
        recurse: yes
      register: auth_keys
    
    - name: Display found authorized_keys
      debug:
        msg: "Found SSH keys: {{ auth_keys.files | map(attribute='path') | list }}"
      when: auth_keys.matched > 0
    
    - name: Backup authorized_keys before removal
      copy:
        src: "{{ item.path }}"
        dest: "{{ item.path }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
      loop: "{{ auth_keys.files }}"
      when: auth_keys.matched > 0
      ignore_errors: yes
    
    - name: Remove SSH authorized_keys (passwordless backdoor)
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ auth_keys.files }}"
      when: auth_keys.matched > 0
    
    - name: Check for UID 0 accounts
      shell: "awk -F: '$3 == 0 && $1 != \"root\" {print $1}' /etc/passwd"
      register: uid0_accounts
      changed_when: false
      failed_when: false
    
    - name: Display UID 0 accounts
      debug:
        msg: "WARNING: Found UID 0 accounts: {{ uid0_accounts.stdout_lines }}"
      when: uid0_accounts.stdout != ""
    
    - name: Find renamed .SAVE files
      find:
        paths:
          - /var/lib
          - /etc
          - /usr/share
        patterns: "*.SAVE"
        recurse: yes
      register: save_files
      ignore_errors: yes
    
    - name: Display found .SAVE files
      debug:
        msg: "Found renamed files: {{ save_files.files | map(attribute='path') | list }}"
      when: save_files.matched > 0
    
    - name: Verify malware removal
      stat:
        path: /etc/startup_check.py
      register: verify_removal
    
    - name: Report final status
      debug:
        msg: "{{ inventory_hostname }}: Malware {{ 'STILL PRESENT - MANUAL ACTION REQUIRED' if verify_removal.stat.exists else 'REMOVED SUCCESSFULLY' }}"
    
    - name: Final warning for manual actions
      debug:
        msg: |
          MANUAL ACTION REQUIRED on {{ inventory_hostname }}:
          - UID 0 accounts found: {{ uid0_accounts.stdout_lines }}
          - .SAVE files found: {{ save_files.files | map(attribute='path') | list }}
          Review and handle these manually!
      when: (uid0_accounts.stdout != "") or (save_files.matched > 0)

- name: Summary Report
  hosts: linux
  gather_facts: no
  become: no
  run_once: yes
  
  tasks:
    - name: Display completion message
      debug:
        msg: |
          ================================================
          EMERGENCY MALWARE REMOVAL COMPLETE
          ================================================
          
          Run these checks on each machine:
          1. Verify service removed: systemctl status startup_check.service
          2. Check for files: ls -la /etc/startup_check.py
          3. Review UID 0 accounts: awk -F: '$3 == 0 {print}' /etc/passwd
          4. Check for .SAVE files: find /var/lib /etc -name "*.SAVE"
          
          Monitor for re-creation:
          - Check every 10 minutes during competition
          - Review logs: journalctl -u startup_check.service
          
          Next steps:
          1. Change ALL passwords (Option 3)
          2. Deploy hardening scripts (Option 4)
          3. Install monitoring agents (Options 5-6)
