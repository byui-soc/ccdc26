---
# CCDC26 - Mass Password Change Playbook
# =======================================
# Changes ALL default passwords across the competition environment
#
# Usage:
#   ansible-playbook -i inventory.ini change_all_passwords.yml -e "new_password=YourNewP@ss123!"
#
# IMPORTANT: Run this IMMEDIATELY after drop flag!

- name: Change passwords on Linux hosts
  hosts: linux
  become: yes
  gather_facts: yes
  vars:
    new_password: "{{ new_password | default('Ccdc2026!Secure') }}"
  tasks:
    - name: Change sysadmin password
      user:
        name: sysadmin
        password: "{{ new_password | password_hash('sha512') }}"
        update_password: always
      when: "'sysadmin' in ansible_user or inventory_hostname != 'splunk'"
      ignore_errors: yes

    - name: Change root password
      user:
        name: root
        password: "{{ new_password | password_hash('sha512') }}"
        update_password: always
      ignore_errors: yes

    - name: Change vyos password (VyOS router)
      shell: |
        source /opt/vyatta/etc/functions/script-template
        configure
        set system login user vyos authentication plaintext-password "{{ new_password }}"
        commit
        save
        exit
      when: inventory_hostname == 'vyos'
      ignore_errors: yes

    - name: Lock unnecessary accounts
      user:
        name: "{{ item }}"
        password_lock: yes
      loop:
        - games
        - news
        - uucp
        - proxy
        - www-data
        - backup
        - list
        - irc
        - gnats
        - nobody
      ignore_errors: yes

- name: Change passwords on Windows hosts  
  hosts: windows
  gather_facts: yes
  vars:
    new_password: "{{ new_password | default('Ccdc2026!Secure') }}"
  tasks:
    - name: Change local administrator password
      win_user:
        name: administrator
        password: "{{ new_password }}"
        update_password: always
      ignore_errors: yes

    - name: Change Administrator password (domain)
      win_shell: |
        Import-Module ActiveDirectory -ErrorAction SilentlyContinue
        Set-ADAccountPassword -Identity "Administrator" -NewPassword (ConvertTo-SecureString "{{ new_password }}" -AsPlainText -Force) -Reset
      when: inventory_hostname == 'ad-dns'
      ignore_errors: yes

    - name: Disable Guest account
      win_user:
        name: Guest
        account_disabled: yes
      ignore_errors: yes

    - name: Change UserOne password (Win11 workstation)
      win_user:
        name: UserOne
        password: "{{ new_password }}"
        update_password: always
      when: inventory_hostname == 'win11-wks'
      ignore_errors: yes

- name: Summary
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Password change summary
      debug:
        msg: |
          =====================================================
          PASSWORD CHANGE COMPLETE
          =====================================================
          New password set across all systems: {{ new_password | default('Ccdc2026!Secure') }}
          
          MANUAL CHANGES STILL REQUIRED:
          1. Palo Alto (172.20.242.150):
             - Login via browser from Ubuntu Wks
             - Device > Administrators > admin > Change Password
          
          2. Cisco FTD (172.20.240.200):
             - Login via browser from Win11 Wks
             - System > Users > Edit admin
          
          3. Splunk Web (172.20.242.20:8000):
             - Settings > Users > admin > Edit
          =====================================================
