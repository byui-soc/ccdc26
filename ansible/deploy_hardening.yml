---
# CCDC26 - Deploy Hardening Scripts Playbook
#
# Deploys the linux-scripts toolkit to all Linux hosts and runs hardening
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_hardening.yml
#   ansible-playbook -i inventory.ini deploy_hardening.yml -e "run_full=true"
#   ansible-playbook -i inventory.ini deploy_hardening.yml --limit web1,db1
#

- name: Deploy hardening scripts to Linux hosts
  hosts: linux
  become: yes
  gather_facts: yes

  vars:
    toolkit_dest: "/opt/ccdc26"
    run_full: false
    run_services: false
    run_monitoring: false

  tasks:
    - name: Detect OS distribution
      set_fact:
        os_distribution: "{{ ansible_distribution | lower | default('unknown') }}"
        os_family: "{{ ansible_os_family | lower | default('unknown') }}"
      changed_when: false

    - name: Create toolkit directory
      file:
        path: "{{ toolkit_dest }}"
        state: directory
        mode: '0755'

    - name: Create linux-scripts subdirectory
      file:
        path: "{{ toolkit_dest }}/linux-scripts"
        state: directory
        mode: '0755'

    - name: Copy linux-scripts directory structure
      copy:
        src: "{{ item }}"
        dest: "{{ toolkit_dest }}/linux-scripts/{{ item | basename }}"
        mode: preserve
      loop: "{{ lookup('fileglob', '../linux-scripts/*', wantlist=True) }}"
      loop_control:
        label: "{{ item | basename }}"
      when: item is file
      ignore_errors: yes

    - name: Copy linux-scripts files recursively (using find + copy)
      shell: |
        cd "{{ playbook_dir }}/../linux-scripts"
        find . -type f -exec install -D -m 0644 {} "{{ toolkit_dest }}/linux-scripts/{}" \;
      changed_when: true
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Make all scripts executable
      shell: |
        find {{ toolkit_dest }}/linux-scripts -name "*.sh" -exec chmod +x {} \;
      changed_when: true
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Run full hardening (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        if [ -f ./hardening/full-harden.sh ]; then
          echo "7" | bash ./hardening/full-harden.sh
        else
          echo "ERROR: full-harden.sh not found"
          exit 1
        fi
      when: run_full | bool
      register: full_harden_result
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Display full harden output
      debug:
        var: full_harden_result.stdout_lines
      when: run_full | bool and full_harden_result is defined

    - name: Run service hardening (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        if [ -f ./services/harden-all.sh ]; then
          echo "1" | bash ./services/harden-all.sh
        else
          echo "ERROR: harden-all.sh not found"
          exit 1
        fi
      when: run_services | bool
      register: services_result
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Deploy monitoring scripts (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        if [ -f ./monitoring/deploy-monitoring.sh ]; then
          nohup bash ./monitoring/deploy-monitoring.sh > /dev/null 2>&1 &
        else
          echo "ERROR: deploy-monitoring.sh not found"
          exit 1
        fi
      when: run_monitoring | bool
      async: 10
      poll: 0
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Display toolkit location
      debug:
        msg: |
          Toolkit deployed to: {{ toolkit_dest }}/linux-scripts/
          
          To run hardening manually:
            cd {{ toolkit_dest }}/linux-scripts
            sudo ./hardening/full-harden.sh
          
          To run service hardening:
            sudo ./services/harden-all.sh
          
          To hunt for persistence:
            sudo ./persistence-hunting/full-hunt.sh


- name: Deploy hardening scripts to Windows hosts
  hosts: windows
  gather_facts: yes

  vars:
    toolkit_dest: "C:\\CCDC-Toolkit"
    run_full: false

  tasks:
    - name: Create toolkit directory
      win_file:
        path: "{{ toolkit_dest }}"
        state: directory

    - name: Create windows-scripts subdirectory
      win_file:
        path: "{{ toolkit_dest }}\\windows-scripts"
        state: directory

    - name: Copy Windows scripts to remote host (using win_copy for directories)
      win_copy:
        src: "{{ item }}"
        dest: "{{ toolkit_dest }}\\windows-scripts\\{{ item | basename }}"
      loop: "{{ lookup('fileglob', '../windows-scripts/*', wantlist=True) }}"
      loop_control:
        label: "{{ item | basename }}"
      when: item is file
      ignore_errors: yes

    - name: Copy Windows scripts recursively (PowerShell method)
      win_shell: |
        $source = "{{ playbook_dir | replace('\\', '/') | replace('/', '\\') }}\..\windows-scripts"
        $dest = "{{ toolkit_dest }}\windows-scripts"
        if (Test-Path $source) {
          Copy-Item -Path "$source\*" -Destination $dest -Recurse -Force
          Write-Output "Copied scripts successfully"
        } else {
          Write-Output "ERROR: Source directory not found: $source"
          exit 1
        }
      register: win_copy_result
      ignore_errors: yes

    - name: Run full hardening (if enabled)
      win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        & "{{ toolkit_dest }}\windows-scripts\hardening\Full-Harden.ps1" -q
      when: run_full | bool
      register: win_harden_result
      ignore_errors: yes

    - name: Display Windows harden output
      debug:
        var: win_harden_result.stdout_lines
      when: run_full | bool and win_harden_result is defined

    - name: Display toolkit location
      debug:
        msg: |
          Toolkit deployed to: {{ toolkit_dest }}\windows-scripts\
          
          To run hardening manually (as Admin):
            cd {{ toolkit_dest }}\windows-scripts\hardening
            .\Full-Harden.ps1
          
          For Domain Controllers:
            .\AD-Harden.ps1
