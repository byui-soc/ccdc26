---
# CCDC26 - Deploy Hardening Scripts Playbook
#
# Deploys the linux-scripts toolkit to all Linux hosts and runs hardening
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_hardening.yml
#   ansible-playbook -i inventory.ini deploy_hardening.yml -e "run_full=true"
#   ansible-playbook -i inventory.ini deploy_hardening.yml --limit web1,db1
#

- name: Deploy hardening scripts to Linux hosts
  hosts: linux
  become: yes
  gather_facts: yes

  vars:
    toolkit_dest: "/opt/ccdc26"
    run_full: false
    run_services: false
    run_monitoring: false

  tasks:
    - name: Create toolkit directory
      file:
        path: "{{ toolkit_dest }}"
        state: directory
        mode: '0755'

    - name: Copy linux-scripts to remote host
      synchronize:
        src: "../linux-scripts/"
        dest: "{{ toolkit_dest }}/linux-scripts/"
        recursive: yes
        delete: no
      delegate_to: localhost

    - name: Make all scripts executable
      shell: |
        find {{ toolkit_dest }}/linux-scripts -name "*.sh" -exec chmod +x {} \;
      changed_when: true

    - name: Run full hardening (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        echo "7" | ./hardening/full-harden.sh
      when: run_full | bool
      register: full_harden_result
      ignore_errors: yes

    - name: Display full harden output
      debug:
        var: full_harden_result.stdout_lines
      when: run_full | bool and full_harden_result is defined

    - name: Run service hardening (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        echo "1" | ./services/harden-all.sh
      when: run_services | bool
      register: services_result
      ignore_errors: yes

    - name: Deploy monitoring scripts (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        ./monitoring/deploy-monitoring.sh &
        disown
      when: run_monitoring | bool
      async: 10
      poll: 0

    - name: Display toolkit location
      debug:
        msg: |
          Toolkit deployed to: {{ toolkit_dest }}/linux-scripts/
          
          To run hardening manually:
            cd {{ toolkit_dest }}/linux-scripts
            sudo ./hardening/full-harden.sh
          
          To run service hardening:
            sudo ./services/harden-all.sh
          
          To hunt for persistence:
            sudo ./persistence-hunting/full-hunt.sh


- name: Deploy hardening scripts to Windows hosts
  hosts: windows
  gather_facts: yes

  vars:
    toolkit_dest: "C:\\CCDC-Toolkit"
    run_full: false

  tasks:
    - name: Create toolkit directory
      win_file:
        path: "{{ toolkit_dest }}"
        state: directory

    - name: Copy Windows scripts to remote host
      win_copy:
        src: "../windows-scripts/"
        dest: "{{ toolkit_dest }}\\windows-scripts\\"

    - name: Run full hardening (if enabled)
      win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        & "{{ toolkit_dest }}\windows-scripts\hardening\Full-Harden.ps1" -q
      when: run_full | bool
      register: win_harden_result
      ignore_errors: yes

    - name: Display Windows harden output
      debug:
        var: win_harden_result.stdout_lines
      when: run_full | bool and win_harden_result is defined

    - name: Display toolkit location
      debug:
        msg: |
          Toolkit deployed to: {{ toolkit_dest }}\windows-scripts\
          
          To run hardening manually (as Admin):
            cd {{ toolkit_dest }}\windows-scripts\hardening
            .\Full-Harden.ps1
          
          For Domain Controllers:
            .\AD-Harden.ps1
