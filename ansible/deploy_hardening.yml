---
# CCDC26 - Deploy Hardening Scripts Playbook
#
# Deploys the linux-scripts toolkit to all Linux hosts and runs hardening
#
# Usage:
#   ansible-playbook -i inventory.ini deploy_hardening.yml
#   ansible-playbook -i inventory.ini deploy_hardening.yml -e "run_full=true"
#   ansible-playbook -i inventory.ini deploy_hardening.yml --limit web1,db1
#

- name: Deploy hardening scripts to Linux hosts
  hosts: linux
  become: yes
  gather_facts: yes

  vars:
    toolkit_dest: "/opt/ccdc26"
    repo_url: "{{ repo_url | default('https://github.com/YOUR_REPO/ccdc26.git') }}"
    repo_branch: "{{ repo_branch | default('main') }}"
    run_full: false
    run_services: false
    run_monitoring: false

  tasks:
    - name: Ensure git is installed (Debian/Ubuntu)
      apt:
        name: git
        state: present
        update_cache: yes
      when: ansible_pkg_mgr == 'apt'

    - name: Ensure git is installed (RHEL/CentOS/Fedora)
      yum:
        name: git
        state: present
      when: ansible_pkg_mgr == 'yum' or ansible_pkg_mgr == 'dnf'

    - name: Clone or update repository
      git:
        repo: "{{ repo_url }}"
        dest: "{{ toolkit_dest }}"
        version: "{{ repo_branch }}"
        update: yes
        force: yes
      register: git_result
      ignore_errors: yes

    - name: Fallback to archive method if git fails
      unarchive:
        src: "{{ repo_url | replace('.git', '') }}/archive/{{ repo_branch }}.zip"
        dest: "{{ toolkit_dest }}"
        remote_src: yes
        creates: "{{ toolkit_dest }}/linux-scripts"
      when: git_result is failed
      ignore_errors: yes

    - name: Make all scripts executable
      shell: |
        find {{ toolkit_dest }}/linux-scripts -name "*.sh" -exec chmod +x {} \;
      changed_when: true
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Run full hardening (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        if [ -f ./hardening/full-harden.sh ]; then
          echo "7" | bash ./hardening/full-harden.sh
        else
          echo "ERROR: full-harden.sh not found"
          exit 1
        fi
      when: run_full | bool
      register: full_harden_result
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Display full harden output
      debug:
        var: full_harden_result.stdout_lines
      when: run_full | bool and full_harden_result is defined

    - name: Run service hardening (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        if [ -f ./services/harden-all.sh ]; then
          echo "1" | bash ./services/harden-all.sh
        else
          echo "ERROR: harden-all.sh not found"
          exit 1
        fi
      when: run_services | bool
      register: services_result
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Deploy monitoring scripts (if enabled)
      shell: |
        cd {{ toolkit_dest }}/linux-scripts
        if [ -f ./monitoring/deploy-monitoring.sh ]; then
          nohup bash ./monitoring/deploy-monitoring.sh > /dev/null 2>&1 &
        else
          echo "ERROR: deploy-monitoring.sh not found"
          exit 1
        fi
      when: run_monitoring | bool
      async: 10
      poll: 0
      ignore_errors: yes
      vars:
        ansible_python_interpreter: "{{ ansible_python_interpreter | default('/usr/bin/python3') }}"

    - name: Display toolkit location
      debug:
        msg: |
          Toolkit deployed to: {{ toolkit_dest }}/linux-scripts/
          
          To run hardening manually:
            cd {{ toolkit_dest }}/linux-scripts
            sudo ./hardening/full-harden.sh
          
          To run service hardening:
            sudo ./services/harden-all.sh
          
          To hunt for persistence:
            sudo ./persistence-hunting/full-hunt.sh


- name: Deploy hardening scripts to Windows hosts
  hosts: windows
  gather_facts: yes

  vars:
    toolkit_dest: "C:\\ccdc26"
    repo_url: "{{ repo_url | default('https://github.com/YOUR_REPO/ccdc26.git') }}"
    repo_branch: "{{ repo_branch | default('main') }}"
    run_full: false

  tasks:
    - name: Check if git is available
      win_shell: |
        $git = Get-Command git -ErrorAction SilentlyContinue
        if ($git) { Write-Output "available" } else { Write-Output "not_available" }
      register: git_check
      changed_when: false

    - name: Clone repository using git (if available)
      win_shell: |
        if (Test-Path "{{ toolkit_dest }}") {
          cd "{{ toolkit_dest }}"
          git pull origin {{ repo_branch }}
        } else {
          git clone -b {{ repo_branch }} {{ repo_url }} "{{ toolkit_dest }}"
        }
      when: git_check.stdout == "available"
      register: git_result
      ignore_errors: yes

    - name: Download and extract ZIP archive (fallback if git not available)
      win_shell: |
        $zipUrl = "{{ repo_url | replace('.git', '') }}/archive/{{ repo_branch }}.zip"
        $zipPath = "$env:TEMP\ccdc26.zip"
        $extractPath = "{{ toolkit_dest }}"
        
        # Download
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
        
        # Extract
        if (Test-Path $extractPath) {
          Remove-Item $extractPath -Recurse -Force
        }
        Expand-Archive -Path $zipPath -DestinationPath (Split-Path $extractPath) -Force
        
        # Rename extracted folder
        $extractedFolder = Join-Path (Split-Path $extractPath) "ccdc26-{{ repo_branch }}"
        if (Test-Path $extractedFolder) {
          Move-Item $extractedFolder $extractPath -Force
        }
        
        # Cleanup
        Remove-Item $zipPath -Force
        Write-Output "Extracted successfully"
      when: git_check.stdout == "not_available" or git_result is failed
      ignore_errors: yes

    - name: Run full hardening (if enabled)
      win_shell: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        & "{{ toolkit_dest }}\windows-scripts\hardening\Full-Harden.ps1" -q
      when: run_full | bool
      register: win_harden_result
      ignore_errors: yes

    - name: Display Windows harden output
      debug:
        var: win_harden_result.stdout_lines
      when: run_full | bool and win_harden_result is defined

    - name: Display toolkit location
      debug:
        msg: |
          Toolkit deployed to: {{ toolkit_dest }}\windows-scripts\
          
          To run hardening manually (as Admin):
            cd {{ toolkit_dest }}\windows-scripts\hardening
            .\Full-Harden.ps1
          
          For Domain Controllers:
            .\AD-Harden.ps1
