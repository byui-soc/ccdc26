# CCDC26 Wazuh Docker Compose - Lightweight Setup
# 
# Minimal Wazuh deployment for resource-constrained VMs (2-4GB RAM)
# Uses only Wazuh Manager (no indexer/dashboard) - agents connect directly
#
# Usage:
#   1. Start Wazuh: docker compose -f docker-compose.lightweight.yml up -d
#   2. Agents connect to manager on port 1514
#   3. View logs: docker logs -f wazuh-manager
#
# Requirements:
#   - Docker 20.10+
#   - Docker Compose v2 or docker-compose v1.29+
#   - 2GB RAM minimum (4GB recommended)
#   - 10GB disk space
#
# Note: This setup does NOT include the dashboard.
# Use the full docker-compose.yml if you need the web interface.
#
# Ports:
#   1514 - Agent events (TCP)
#   1515 - Agent enrollment (TCP)
#   514  - Syslog (UDP)
#

version: '3.8'

services:
  wazuh.manager:
    image: wazuh/wazuh-manager:4.7.2
    hostname: wazuh.manager
    container_name: wazuh-manager
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.25'
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1514:1514"     # Agent events
      - "1515:1515"     # Agent enrollment
      - "514:514/udp"   # Syslog
    environment:
      # Disable indexer connection (not used in lightweight mode)
      - INDEXER_URL=
      # API credentials (for agent registration)
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=MyS3cr37P450r.*-
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_integrations:/var/ossec/integrations
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_agentless:/var/ossec/agentless
      - wazuh_wodles:/var/ossec/wodles
      # Mount custom rules if available
      - ../rules:/var/ossec/etc/rules/ccdc:ro
    networks:
      - wazuh-net
    healthcheck:
      test: ["CMD", "/var/ossec/bin/wazuh-control", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  wazuh-net:
    driver: bridge

volumes:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_var_multigroups:
  wazuh_integrations:
  wazuh_active_response:
  wazuh_agentless:
  wazuh_wodles:
